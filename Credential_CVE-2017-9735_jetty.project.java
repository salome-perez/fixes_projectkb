public class Credential {
    protected static boolean stringEquals(String s1, String s2)
    {
        if (s1 == s2)
            return true;
        if (s1 == null || s2 == null || s1.length() != s2.length())
            return false;
        boolean result = true;
        for (int i = 0; i < s1.length(); i++)
            result &= s1.charAt(i) == s2.charAt(i);
        return result;
    }

        @Override
        public boolean check(Object credentials)
        {
            try
            {
                if (credentials instanceof char[])
                    credentials=new String((char[])credentials);
                if (credentials instanceof Password || credentials instanceof String)
                {
                    byte[] digest;
                    synchronized (__md5Lock)
                    {
                        if (__md == null) __md = MessageDigest.getInstance("MD5");
                        __md.reset();
                        __md.update(credentials.toString().getBytes(StandardCharsets.ISO_8859_1));
                        digest = __md.digest();
                    }
                    return byteEquals(_digest, digest);
                }
                else if (credentials instanceof MD5)
                {
                    MD5 md5 = (MD5)credentials;
                    return byteEquals(_digest, md5._digest);
                }
                else if (credentials instanceof Credential)
                {
                    // Allow credential to attempt check - i.e. this'll work
                    // for DigestAuthModule$Digest credentials
                    return ((Credential)credentials).check(this);
                }
                else
                {
                    LOG.warn("Can't check " + credentials.getClass() + " against MD5");
                    return false;
                }
            }
            catch (Exception e)
            {
                LOG.warn(e);
                return false;
            }
        }

    protected static boolean byteEquals(byte[] b1, byte[] b2)
    {
        if (b1 == b2)
            return true;
        if (b1 == null || b2 == null || b1.length != b2.length)
            return false;
        boolean result = true;
        for (int i = 0; i < b1.length; i++)
            result &= b1[i] == b2[i];
        return result;
    }

}