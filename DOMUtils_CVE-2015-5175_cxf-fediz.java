public class DOMUtils {
    private static DocumentBuilder getBuilder() throws ParserConfigurationException {
        ClassLoader loader = Thread.currentThread().getContextClassLoader();
        if (loader == null) {
            loader = DOMUtils.class.getClassLoader();
        }
        if (loader == null) {
            DocumentBuilderFactory dbf = createDocumentBuilderFactory();
            return dbf.newDocumentBuilder();
        }
        DocumentBuilder builder = DOCUMENT_BUILDERS.get(loader);
        if (builder == null) {
            DocumentBuilderFactory dbf = createDocumentBuilderFactory();
            builder = dbf.newDocumentBuilder();
            DOCUMENT_BUILDERS.put(loader, builder);
        }
        return builder;
    }

    public static Document readXml(StreamSource is) throws SAXException, IOException,
        ParserConfigurationException {
        InputSource is2 = new InputSource();
        is2.setSystemId(is.getSystemId());
        is2.setByteStream(is.getInputStream());
        is2.setCharacterStream(is.getReader());

        DocumentBuilder db = getBuilder();
        return db.parse(is2);
    }

    private static DocumentBuilderFactory createDocumentBuilderFactory() throws ParserConfigurationException {
        DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();
        dbf.setFeature(XMLConstants.FEATURE_SECURE_PROCESSING , true);

        dbf.setValidating(false);
        dbf.setIgnoringComments(false);
        dbf.setIgnoringElementContentWhitespace(true);
        dbf.setNamespaceAware(true);
        // dbf.setCoalescing(true);
        // dbf.setExpandEntityReferences(true);
        
        return dbf;
    }

    public static void writeXml(Node n, OutputStream os) throws TransformerException {
        TransformerFactory tf = TransformerFactory.newInstance();
        tf.setFeature(XMLConstants.FEATURE_SECURE_PROCESSING , true);
        // identity
        Transformer t = tf.newTransformer();
        t.setOutputProperty(OutputKeys.INDENT, "yes");
        t.transform(new DOMSource(n), new StreamResult(os));
    }

}