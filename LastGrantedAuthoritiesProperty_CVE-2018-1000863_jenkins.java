public class LastGrantedAuthoritiesProperty {
    public GrantedAuthority[] getAuthorities() {
        String[] roles = this.roles;    // capture to a variable for immutability

        if(roles == null){
            return new GrantedAuthority[]{SecurityRealm.AUTHENTICATED_AUTHORITY};
        }

        String authenticatedRole = SecurityRealm.AUTHENTICATED_AUTHORITY.getAuthority();
        List<GrantedAuthority> grantedAuthorities = new ArrayList<>(roles.length + 1);
        grantedAuthorities.add(new GrantedAuthorityImpl(authenticatedRole));

        for (int i = 0; i < roles.length; i++){
            // to avoid having twice that role
            if(!authenticatedRole.equals(roles[i])){
                grantedAuthorities.add(new GrantedAuthorityImpl(roles[i]));
            }
        }

        return grantedAuthorities.toArray(new GrantedAuthority[grantedAuthorities.size()]);
    }

}