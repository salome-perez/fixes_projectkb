public class MAPCodec {
    private void restoreExchange(SoapMessage message, AddressingProperties maps) {
        if (maps != null
            && maps.getRelatesTo() != null
            && !Names.WSA_UNSPECIFIED_RELATIONSHIP.equals(maps.getRelatesTo().getValue())
            && isRelationshipReply(maps.getRelatesTo())) {
            Exchange correlatedExchange =
                uncorrelatedExchanges.remove(maps.getRelatesTo().getValue());
            if (correlatedExchange != null) {
                synchronized (correlatedExchange) {
                    message.setExchange(correlatedExchange);
                }
            } else if (ContextUtils.isRequestor(message) && !message.getExchange().isOneWay()) {
                if (ContextUtils.retrieveDeferUncorrelatedMessageAbort(message)) {
                    LOG.fine("deferring uncorrelated message abort");
                    ContextUtils.storeDeferredUncorrelatedMessageAbort(message);
                } else if (!MessageUtils.getContextualBoolean(message,
                                          "org.apache.cxf.ws.addressing.MAPAggregator.addressingDisabled",
                                          false)) {
                    //see if it can directly be correlated with the out message:
                    Message outmsg = message.getExchange().getOutMessage();
                    AddressingProperties outp = outmsg != null
                        ? ContextUtils.retrieveMAPs(outmsg, false, true, false) : null;
                    if (outp == null
                        || !outp.getMessageID().getValue().equals(maps.getRelatesTo().getValue())) {
                        LOG.log(Level.WARNING, "CORRELATION_FAILURE_MSG");
                        message.getInterceptorChain().abort();
                    }
                }
            }
        } else if (isRequestor(message)) {
            if (maps == null) {
                Message m = message.getExchange().getOutMessage();
                maps = ContextUtils.retrieveMAPs(m, false, true, false);
                if (maps != null) {
                    Exchange ex = uncorrelatedExchanges.get(maps.getMessageID().getValue());
                    if (ex == message.getExchange()) {
                        uncorrelatedExchanges.remove(maps.getMessageID().getValue());
                        LOG.log(Level.WARNING, "RESPONSE_NOT_USING_WSADDRESSING");
                    }
                }
            } else if (maps.getRelatesTo() == null
                && maps.getAction() != null
                && (Names.WSA_DEFAULT_FAULT_ACTION.equals(maps.getAction().getValue())
                    || Names.WSA_DEFAULT_SOAP_FAULT_ACTION.equals(maps.getAction().getValue()))) {
                //there is an Action header that points to a fault and no relatesTo.  Use the out map for the ID
                Message m = message.getExchange().getOutMessage();
                maps = ContextUtils.retrieveMAPs(m, false, true, false);
                if (maps != null) {
                    uncorrelatedExchanges.remove(maps.getMessageID().getValue());
                }
            }
        }

    }

}